<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Metaverse</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3"
      crossorigin="anonymous"
    />
    <style>
	  body {
				margin: 0;
			}
    
    .progress-bar-container{
      position:absolute;
      left: 50%;
      top:50%;
      transform: translate(-50%,-50%);
      width: 100%;
      height: 100%;
      background-color: rgb(0, 0, 0);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }

    #progress-bar{
      width:30%;
      margin-top:0.5%;
      height: 2%;
    }

    .progress-label{
      color:white;
      font-size: 2rem;
    }
    </style>
  </head>
  <body>
	<script type="importmap">
		{
			"imports": {
				"three": "./three.module.js"
			}
		}
	</script>
    <script src="./three.js"></script>
    <script src="https://unpkg.com/web3@latest/dist/web3.min.js"></script>
	<script type="module">
import Movements from "./src/movements.js";
import blockchain from "./src/Web3.js";
import abi from "./src/abi/abi.json" assert { type: "json" };
import * as THREE from "three";
import { OrbitControls, MapControls } from "./controls/OrbitControls.js";
import { smart_contract_address } from "./src/contractparams.js";
import { VRButton } from "./src/VRButton.js";
import { GLTFLoader } from "./src/GLTFLoader.js";


// Declaration  of a new scene with Three.js
const container = document.querySelector(".scene");

const scene = new THREE.Scene();
scene.background = new THREE.Color(0x404040);

// Camera and renderer configuration
const camera = new THREE.PerspectiveCamera(
  70,
  window.innerWidth / window.innerHeight,
  1,
  10000
);
const renderer = new THREE.WebGLRenderer();
renderer.setSize(window.innerWidth, window.innerHeight);
document.body.appendChild(renderer.domElement);
document.body.appendChild(VRButton.createButton(renderer));
renderer.xr.enabled = true;



// Orbit controls
let controls = new OrbitControls(camera, renderer.domElement);

// Setting the scene lights
const ambient_light = new THREE.AmbientLight(0xffffff, 0.8);
const direction_light = new THREE.DirectionalLight(0xebd7d3, 0.3);
direction_light.position.set(0, 0, 0);
direction_light.target.position.set(0, 0, 0);
ambient_light.add(direction_light);
scene.add(ambient_light);

//point light
const Point_Light = new THREE.PointLight(0xdb5424, 1.5);
Point_Light.position.set(30, 100, 30);
scene.add(Point_Light);

//Rect Light
const width = 2.0;
const height = 20.0;
const RectLight = new THREE.RectAreaLight(0xffffff, 1.0, width, height);
RectLight.position.set(100, 10, 0);
RectLight.lookAt(0, 0, 0);
scene.add(RectLight);

//Loading Screen
const loadingManager = new THREE.LoadingManager();
loadingManager.onStart = function(url,item,total){
  console.log(`started loading:${url}`)
}

const progressBar = document.getElementById("progress-bar")

loadingManager.onProgress = function(url,loaded,total){
  progressBar.value = (loaded/total) *100;
}

const progressBarContainer = document.querySelector('.progress-bar-container')

loadingManager.onLoad = function(){
  progressBarContainer.style.display = "none"
}

//Load 3D models
const loader = new GLTFLoader(loadingManager);
//flying Island
loader.load("../models/flying/scene.gltf", function (gltf) {
  scene.add(gltf.scene);
  let flying = gltf.scene.children[0];
  flying.position.set(500, -80, -50);
  flying.scale.set(0.1, 0.1, 0.1);
});

//magic ring -yellow
loader.load("../models/magic_ring/scene.gltf", function (gltf) {
  scene.add(gltf.scene);
  let magic = gltf.scene.children[0];
  magic.position.set(-38, 80, 120);
  magic.scale.set(7, 7, 7);
  magic.rotation.set(0, 0, Math.PI);
});

//magic crystals
loader.load("../models/magic_crystals/scene.gltf", function (gltf) {
  scene.add(gltf.scene);
  let crystal = gltf.scene.children[0];
  crystal.position.set(10, 25, -290);
  crystal.scale.set(0.8, 0.8, 0.8);
  crystal.rotation.set(Math.PI / -2, 0, 0);
});

//sky
loader.load("../models/sky/scene.gltf", function (gltf) {
  scene.add(gltf.scene);
  let sky = gltf.scene.children[0];
  sky.position.set(0, 0, -3500);
  sky.scale.set(3, 3, 3);
  sky.rotation.set(Math.PI / 2, 0, 0);
});

//dragon
loader.load("../models/dragon/scene.gltf", function (gltf) {
  scene.add(gltf.scene);
  let dragon = gltf.scene.children[0];
  dragon.position.set(-400, -60, -100);
  dragon.scale.set(15, 15, 15);
  dragon.rotation.set(Math.PI / -2, 0, 0);
});

window.addEventListener("resize", onWindowResize);

camera.position.set(250, 10, 0);

function animate() {
  renderer.setAnimationLoop(render);
}

function render() {
  requestAnimationFrame(animate);
  controls.update();
  // Movement to the left
  if (Movements.isPressed(37)) {
    camera.position.x -= 1.5;
  }
  // Upward movement
  if (Movements.isPressed(38)) {
    camera.position.x += 1.5;
    camera.position.y += 1.5;
  }
  // Movement to the right
  if (Movements.isPressed(39)) {
    camera.position.x += 1.5;
  }
  // Downward movement
  if (Movements.isPressed(40)) {
    camera.position.x -= 1.5;
    camera.position.y -= 1.5;
  }

  // camera.lookAt(space.position);
  renderer.render(scene, camera);
}
animate();

function onWindowResize() {
  camera.aspect = window.innerWidth / window.innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(window.innerWidth, window.innerHeight);
}

// New NFT
const buttonMint = document.getElementById("mint");
buttonMint.addEventListener("click", mintNFT);

function mintNFT() {
  // Parameters to create a NFT in the Metaverse
  let nft_name = document.getElementById("nft_name").value;
  let nft_width = document.getElementById("nft_width").value;
  let nft_height = document.getElementById("nft_height").value;
  let nft_depth = document.getElementById("nft_depth").value;
  let nft_x = document.getElementById("nft_x").value;
  let nft_y = document.getElementById("nft_y").value;
  let nft_z = document.getElementById("nft_z").value;

  // If Metamask is not available
  if (typeof window.ethereum == "undefined") {
    rej("You should install Metamask to use it!");
  }

  // Web3 Instance
  let web3 = new Web3(window.ethereum);
  let contract = new web3.eth.Contract(abi, smart_contract_address);

  web3.eth.getAccounts().then((accounts) => {
    contract.methods
      .cost()
      .call()
      .then((cost_nft) => {
        contract.methods
          .mint(nft_name, nft_width, nft_height, nft_depth, nft_x, nft_y, nft_z)
          .send({ from: accounts[0], value: parseInt(cost_nft) })
          .then((data) => {
            alert("NFT available in the Metaverse!");
          });
      });
  });
}

// Profit extraction
const buttonProfit = document.getElementById("profit");
buttonProfit.addEventListener("click", profitNFT);

function profitNFT() {
  // If Metamask is not available
  if (typeof window.ethereum == "undefined") {
    rej("You should install Metamask to use it!");
  }

  // Web3 Instance
  let web3 = new Web3(window.ethereum);
  let contract = new web3.eth.Contract(abi, smart_contract_address);

  web3.eth.getAccounts().then((accounts) => {
    contract.methods
      .withdraw()
      .send({ from: accounts[0] })
      .then((data) => {
        alert("Profit extraction!");
      });
  });
}

// Web3 connection to the data generated in the blockchain to be
// represented in the Metaverse
const NFT = blockchain.then((result) => {
  // For each building paid for in the Smart Contract,
  // a graphical representation is made in the Metaverse
  result.building.forEach((building, index) => {
    if (index <= result.supply) {
      // Representation of NFT Tokens as boxes
      const boxGeometry = new THREE.OctahedronGeometry(
        building.w
        // building.h,
        // building.d
      );
      const boxMaterial = new THREE.MeshPhongMaterial({
        color: 0xe3d534,
        specular: 0x050505,
      });
       let nft = new THREE.Mesh(boxGeometry, boxMaterial);
      nft.position.set(building.x, building.y, building.z);
      scene.add(nft);
    }
  });
});

	</script>


	<form onsubmit="return false">
	<div class="row g-3">
		<div class="col-sm">
			<label class="form-label">NFT name</label>
			<input class="form-control" type="text" id="nft_name" required/>
		</div>

		<div class="col-sm">
			<label class="form-label">NFT width</label>
			<input class="form-control" type="number" id="nft_width" required/>
		</div>

		<div class="col-sm">
			<label class="form-label">NFT height</label>
			<input class="form-control" type="number" id="nft_height" required/>
		</div>

		<div class="col-sm">
			<label class="form-label">NFT depth</label>
			<input class="form-control" type="number" id="nft_depth" required/>
		</div>

		<div class="col-sm">
			<label class="form-label">X position</label>
			<input class="form-control" type="number" id="nft_x" required/>
		</div>

		<div class="col-sm">
			<label class="form-label">Y position</label>
			<input class="form-control" type="number" id="nft_y" required/>
		</div>

		<div class="col-sm">
			<label class="form-label">Z position</label>
			<input class="form-control" type="number" id="nft_z" required/>
		</div>

		<button id="mint" type="submit" class="btn btn-primary">
			Create a new NFT!
		</button>
	</div>
	</form>

	<div  class="row g-3">
		<button id="profit" type="submit" class="btn btn-danger">
			Profit extraction
		</button>
	</div>
<div class ="scene"></div>
<div class ="progress-bar-container">
  <label class ="progress-label" for = "progress-bar">Loading...</label>
  <progress id = "progress-bar" value = "0" max= "100"></progress>
</div>
  </body>
</html>
